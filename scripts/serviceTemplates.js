//---------------------------------------------------------------------
// <copyright file="serviceTemplate.js">
//    This code is licensed under the MIT License.
//    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF 
//    ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED 
//    TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A 
//    PARTICULAR PURPOSE AND NONINFRINGEMENT.
// </copyright>
// <summary>A service so handle templates.</summary>
//---------------------------------------------------------------------

try { angular.module("ExportQuery.services") } catch (err) { angular.module('ExportQuery.services', []);  }
angular.module('ExportQuery.services').service('TemplateService', function () {

    this.TemplateList = null;

    this.init = function () {
        var deferred = $.Deferred();

        var service = this;

        VSS.ready(function () {

            // Get the data service
            VSS.getService(VSS.ServiceIds.ExtensionData).then(function (dataService) {
                service.dataService = dataService;
                deferred.resolve(service);
            });

  


        });

        return deferred.promise();
    };

    this.fetchPermissions = function () {
        var deferred = $.Deferred();
        VSS.require(["VSS/Service", "VSS/Security/RestClient"], function (VSS_Service, Security_RestClient) {

            if (Security_RestClient.SecurityHttpClient2_3 != null) {
                //Checking so we got support for 2_3 (Tfs2015.2 doesnt )
                var client = VSS_Service.getCollectionClient(Security_RestClient.SecurityHttpClient2_3);

                client.hasPermissions("1f4179b3-6bac-4d01-b421-71ea09171400", 2 /* write */, "FrameworkGlobalSecurity", true).then(
                    function (response) {
                        deferred.resolve(response[0]);
                    },
                    function (err) {
                        console.log(err);
                        deferred.resolve(false);
                    });
            }
            else {
                //IF tfs2015.2 -without support for permissions - enable for everyone
                deferred.resolve(true);
            }

            //var client = VSS_Service.getCollectionClient(Security_RestClient.SecurityHttpClient3);

            
            //client.hasPermissionsBatch({
            //    evaluations: [
            //       {
            //           securityNamespaceId: "1f4179b3-6bac-4d01-b421-71ea09171400", /* framework */
            //           token: "FrameworkGlobalSecurity",
            //           permissions: 2 /* write */
            //       }
            //    ],
            //    alwaysAllowAdministrators: true
            //}).then(
            //    function (response) {
            //        deferred.resolve(response.evaluations[0].value);
            //    },
            //    function (err) {
            //        console.log(err);
            //        deferred.resolve(false);
            //    });
        });
        return deferred.promise()
    };

     this.loadAllTemplates = function ($http) {
        var serviceList =[];
        angular.forEach(angular.module("ExportQuery.services")._invokeQueue, function(a) {
            serviceList.push(a[2][0]);
        });

        return this.loadTemplates("WorkItemQuery", $http);
    };

    this.loadTemplates = function (serviceName, showAll,  $http) {
        var deferred = $.Deferred();
        var service = this;
        
        var vsoContext = VSS.getWebContext();

        var prmLst = [];
        prmLst.push(service.dataService.getDocuments(getDocumentCollectionUrl(vsoContext, serviceName)));
        prmLst.push(service.dataService.getDocuments(getDocumentCollectionUrl(null, serviceName)));
        prmLst.push(getDefaultTempaltes(serviceName, $http) );

        Q.allSettled(prmLst).then(
            function (results) {
                var list = [];
                for(var x=0; x<=2;x++){
                    result = results[x];
    
                    if (result.state === "fulfilled") {
                       
                        var scope = "";
                        var tmplLst = [];
                        if (x == 2) {
                            scope = "Default";
                            tmplLst = result.value.templates;
                        }
                        else if (x == 1) {
                            scope = "Collection";
                            tmplLst = result.value;
                        }
                        else {
                            scope = "Project";
                            tmplLst = result.value;
                        }
                        tmplLst.forEach(function (i) {
                            i.serviceName = serviceName; i.unSaved = '';
                            i.scope = scope;
                            if(showAll || list.filter(function(itm){return itm.id==i.id;}).length==0 ){
                                list.push(i);
                            }
                            
                        });
                    }
                };
                service.TemplateList = list;
                
                deferred.resolve(service.TemplateList);

            }
            , function (error) {
                deferred.reject("No default template");
            }
        );

        return deferred.promise();
    };

    this.saveTemplate = function (template, $http) {
        var deferred = $.Deferred();
        var service = this;
        VSS.ready(function () {
            var vsoContext = null;
            VSS.getWebContext();
            
            // Get the data service
            service.fetchPermissions().then(function (collectionPermissions) {
                template.__etag = -1;

                var ok2Save = false;
                if (template.scope === "Collection" ) {
                    if (collectionPermissions==true) {
                        ok2Save = true;
                    }
                    else {
                        deferred.reject("Edit Collection Level permissions is required to save collection scoped templates")
                    }
                }
                if (template.scope === "Project") {
                    vsoContext = VSS.getWebContext();
                    ok2Save = true;
                }

                if(ok2Save){
                    // set an account-scoped document in a collection
                    service.dataService.setDocument(getDocumentCollectionUrl(vsoContext , template.serviceName), template).then(
                        function (doc) {
                            deferred.resolve(doc);
                        },
                        function (err) {
                            deferred.reject(err);
                        });
                }
            });

        });
        return deferred.promise();
    };

    this.deleteTemplate = function (template) {
        var deferred = $.Deferred();
        var service = this;
        VSS.ready(function () {
            var vsoContext = VSS.getWebContext();
            
            // Get the data service
            VSS.getService(VSS.ServiceIds.ExtensionData).then(function (dataService) {
               
                // set an account-scoped document in a collection
                dataService.deleteDocument(getDocumentCollectionUrl(vsoContext, template.serviceName), template.id).then(
                    function (doc) {
                        deferred.resolve(doc);
                    },
                    function (err) {
                        deferred.reject(err);
                    });
            });

        });
        return deferred.promise();
    };
});
function getDocumentCollectionUrl(vsoContext, serviceName) {
    // Limitied to 50 characters :(
    var root= "";
    if(vsoContext!=null){
        root=vsoContext.project.id + '-' ;
    }

    return root + serviceName;
}

function getDefaultTempaltes(serviceName, $http)
{
    var extContext = VSS.getExtensionContext();
    var defaultTemplateUrl = extContext.baseUri + "/DefaultTemplates/" + serviceName + ".json";

    var deferred = $.Deferred();

    $.getJSON(defaultTemplateUrl)
        .then(function (data) {
            deferred.resolve(data);
        }, function (data, status) {
            if (serviceName === "WorkItemQuery") {
                deferred.resolve({
                    "id": "WorkItemQuery",
                    "templates": [
                      {
                          "id": "mskold-Grid",
                          "name": "Grid",
                          "serviceName": "WorkItemQuery",
                          "description": "A TFS grid optimized for design and UX",
                          "docType": "xls",
                          "template": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet version=\"1.0\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\">\n\n  <xsl:template match=\"/\">\n    <html>\n \n\n      <body>\n        <div class=\"query-result-grid work-item-list grid has-header has-gutter\" id=\"27\" role=\"grid\" aria-readonly=\"true\" style=\"height:1000px;\">\n          <div class=\"grid-focus\" tabindex=\"0\" role=\"grid\"></div>\n          \n                     <xsl:apply-templates select=\"/result/columns\" mode=\"th\"/>\n\n                <div class=\"grid-canvas ui-draggable\">\n\n                  <xsl:apply-templates select=\"/result/workitem\" mode=\"row\"/>\n\n\n                </div>\n              </div>\n      \n      </body>\n\n    </html>\n  </xsl:template>\n\n  <xsl:template match=\"result/columns\" mode=\"th\">\n  \n        <div class=\"grid-header\">\n          <div class=\"grid-header-canvas\" role=\"gridcell\" style=\"left: 20px;\">\n            <xsl:for-each select=\"*\">\n            <div title=\"{@name}\" class=\"grid-header-column\" style=\"width: {@width}px;\">\n            <div class=\"separator\"></div>\n            <div class=\"title\"><xsl:value-of select=\"@name\"/></div>\n            <div class=\"sort-handle\"></div>\n          </div>\n          </xsl:for-each>\n        </div>\n        <div class=\"grid-gutter-header\"></div>\n      </div>\n  </xsl:template>\n\n\n  <xsl:template match=\"//workitem\" mode=\"row\">\n  \n      \n        <div class=\"grid-row grid-row-normal \"  role=\"row\" style=\"left: 20px; top: {26 * position()}px; width: 874px; height: 26px;\">\n\n          <xsl:variable name=\"collectionUrl\" select=\"/result/@collectionUrl\"></xsl:variable>\n          <xsl:variable name=\"curRow\" select=\"*[name()!='workitem']\"></xsl:variable>\n\n          <xsl:for-each select=\"/result/columns/*\">\n            \n            <xsl:variable name=\"columnField\" select=\"name()\"/>\n            <xsl:variable name=\"columnWidth\" select=\"@width\"/>\n            \n            <xsl:variable name=\"value\" select=\"$curRow[name()=$columnField]\"/>\n\n            <xsl:variable name=\"bgColor\" >\n              <xsl:choose>\n                <xsl:when test=\"$columnField='Microsoft.VSTS.Common.Priority'\">\n                  <xsl:if test=\"$value=1\">\n                    red\n                  </xsl:if>\n                </xsl:when>\n                </xsl:choose>\n            </xsl:variable>\n\n\n       \n\n            <div title=\"{$value}\" class=\"grid-cell\" role=\"gridcell\" style=\"width: {$columnWidth}px;background-color:{$bgColor}\">\n              <xsl:if test=\"$value[@md5!='']\">\n                <img style =\"float:left;height:24px \" src=\"{$collectionUrl}/_api/_common/IdentityImage?Id=&amp;identifier={$value/@email}&amp;resolveAmbiguous=false&amp;identifierType=0&amp;size=1&amp;__v=5'\">\n<!--           <img src=\"http://www.gravatar.com/avatar/{$value/@md5}\" style=\"display:inline; height=24px;width:24px;\"> -->\n\n                <xsl:attribute name=\"alt\">\n                    <xsl:value-of select=\"$value\"/>\n                  </xsl:attribute>\n                  <xsl:attribute name=\"title\">\n                    <xsl:value-of select=\"$value\" />\n                  </xsl:attribute>\n                </img>\n              </xsl:if>\n\n              <xsl:value-of select=\"$value\" />\n            </div>\n              \n            \n            </xsl:for-each>\n       \n        </div>\n\n    \n    \n\n  </xsl:template>\n\n\n</xsl:stylesheet>",
                          "__etag": -1
                      },
                      {
                          "id": "mskold-export-table",
                          "name": "Export table",
                          "serviceName": "WorkItemQuery",
                          "description": "A table optimized for exporting to excel",
                          "template": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet version=\"1.0\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\">\n\n  <xsl:template match=\"/\">\n    <html content-type=\"application/vnd.ms-excel\">\n \n\n    <body>\n      <table  aria-readonly=\"true\" >\n          <xsl:apply-templates select=\"/result/columns\" mode=\"th\"/>\n          <tbody>\n                  <xsl:apply-templates select=\"/result/workitem\" mode=\"row\"/>\n          </tbody>\n      </table>\n      </body>\n\n    </html>\n  </xsl:template>\n\n  <xsl:template match=\"result/columns\" mode=\"th\">\n  \n        <thead class=\"grid-header\" style=\"position:relative\">\n          \n          <tr class=\"grid-header-canvas\" style=\"position:relative;text-align:left\" >\n            <xsl:for-each select=\"*\">\n            <th title=\"{@name}\" class=\"grid-header-column\" style=\"width: {@width}px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; vertical-align: middle; text-align: left; cursor: default; padding: 4px;\" >\n             <xsl:value-of select=\"@name\"/>\n              </th>\n          \n          </xsl:for-each>\n        </tr>\n        \n      </thead>\n  </xsl:template>\n\n\n  <xsl:template match=\"//workitem\" mode=\"row\">\n\n       <tr>\n          <xsl:variable name=\"collectionUrl\" select=\"/result/@collectionUrl\"></xsl:variable>\n          <xsl:variable name=\"curRow\" select=\"*[name()!='workitem']\"></xsl:variable>\n\n          <xsl:for-each select=\"/result/columns/*\">\n            \n            <xsl:variable name=\"columnField\" select=\"name()\"/>\n            <xsl:variable name=\"columnWidth\" select=\"@width\"/>\n            \n            <xsl:variable name=\"value\" select=\"$curRow[name()=$columnField]\"/>\n\n            <xsl:variable name=\"bgColor\" >\n              <xsl:choose>\n                <xsl:when test=\"$columnField='Microsoft.VSTS.Common.Priority'\">\n                  <xsl:if test=\"$value=1\">\n                    red\n                  </xsl:if>\n                  \n                </xsl:when>\n                </xsl:choose>\n            </xsl:variable>\n\n           <td title=\"{$value}\" class=\"grid-cell\"  style=\"width: {$columnWidth}px;background-color:{$bgColor}\">\n              <xsl:if test=\"$value[@md5!='']\">\n                <img style =\"float:left;height:24px \" src=\"{$collectionUrl}/_api/_common/IdentityImage?Id=&amp;identifier={$value/@email}&amp;resolveAmbiguous=false&amp;identifierType=0&amp;size=1&amp;__v=5'\">\n<!--           <img src=\"http://www.gravatar.com/avatar/{$value/@md5}\" style=\"display:inline; height=24px;width:24px;\"> -->\n\n                <xsl:attribute name=\"alt\">\n                    <xsl:value-of select=\"$value\"/>\n                  </xsl:attribute>\n                  <xsl:attribute name=\"title\">\n                    <xsl:value-of select=\"$value\" />\n                  </xsl:attribute>\n                </img>\n              </xsl:if>\n\n              <xsl:value-of select=\"$value\" />\n            </td>\n           </xsl:for-each>\n        </tr>\n  </xsl:template>\n\n</xsl:stylesheet>",
                          "docType": "xls",
                          "__etag": -1
                      },
                      {
                          "id": "mskold-RequirementSpecification",
                          "name": "Requirement Specification",
                          "serviceName": "WorkItemQuery",
                          "description": "",
                          "docType": "doc",
                          "template": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet version=\"1.0\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\">\n    <xsl:output method=\"html\" indent=\"yes\" encoding=\"Windows-1252\"/>\n\n  <xsl:template match=\"/\">\n    \n    <html>\n <head>\n <meta charset=\"UTF-8\" />       <style>\n          body {font-family: 'Segoe UI'; font-size: 11px;}\n          .StoryInfo{font-size: '9px';}\n          .tag-box{\n            margin-left:6 px;\n            padding-left: 6px;\n          padding-top: 2px;\n        padding-right: 6px;\n        padding-bottom: 2px;\n        font-size: 9px;\n        color: #4F4F4F;\n        background-color: #d7e6f3;\n        }\n        h2 {font-size: 22px; margin-bottom:2px;}\n        h3 {font-size: 18px; margin-bottom:2px;}\n        h4 {font-size: 14px; margin-bottom:2px;}\n        \n        .AcceptanceCriteriaHeader {font-weight:bold;}\n        </style>\n      </head>\n      <body>\n<!-- Insert a fake table to force word to load the output as a doc -->\n  <table>\n          <tr>\n            <td></td>\n          </tr>\n        </table>\n\n        <h1>Requirement specification</h1>\n\n        <xsl:apply-templates select=\"*\" />\n    \n\n        <p/>\n      </body>\n    </html>\n  </xsl:template>\n  \n  <xsl:template match=\"//workitem\">\n    \n      <xsl:variable name=\"level\" select=\"count(ancestor-or-self::*) \"/>\n   \n      <xsl:element name=\"h{$level}\">\n         <xsl:number level=\"multiple\" format=\"1. \"/> \n        <xsl:value-of select=\"System.Title\" />\n      </xsl:element >\n    \n    <div style=\"margin-left:15px;\">\n\n\n      <div class=\"StoryInfo\">\n        <hr/>\n       #<xsl:value-of select=\"System.Id\" />\n        State:<xsl:value-of select=\"System.State\" />\n       Assigned to: <xsl:value-of select=\"System.AssignedTo\" />\n      Tags: <xsl:apply-templates select=\"System.Tags/tag\" />\n        <hr/>\n      </div>\n       <xsl:apply-templates select=\"System.Description\" />\n      \n      <xsl:apply-templates select=\"Microsoft.VSTS.Common.AcceptanceCriteria\" />\n      \n      <xsl:apply-templates select=\"workitem\" />\n    </div>\n  </xsl:template>\n    \n  <xsl:template match=\"//tag\">\n\n    <span class=\"tag-box\">\n      <xsl:value-of select=\"text()\" />\n      </span>\n  </xsl:template>\n\n  \n    \n  <xsl:template match=\"//System.Description\">\n\n      <xsl:copy-of select=\"*\" />\n  </xsl:template>\n  <xsl:template match=\"//Microsoft.VSTS.Common.AcceptanceCriteria\">\n\n    <span class=\"AcceptanceCriteriaHeader\">Acceptance criteria:</span>\n    <br/>\n      <xsl:copy-of select=\"*\" />\n  </xsl:template>\n  \n\n\n</xsl:stylesheet>",
                          "__etag": -1
                      }

                    ]
                }
                );
            }
            else if (serviceName === "TestPlan") {
                deferred.resolve({
                    "id": "TestPlan",
                    "templates": [
                        { "id": "mskold-TestPlanSummary", "name": "Test plan summary", "description": "", "docType": "doc", "template": "<?xml version=\"1.0\" encoding=\"utf-8\" ?>\n<xsl:stylesheet version=\"1.0\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:fo=\"http://www.w3.org/1999/XSL/Format\" >\n  <xsl:output method=\"html\" indent=\"yes\" encoding=\"utf-8\" doctype-public=\"-//W3C//DTD XHTML 1.0 Transitional//EN\" doctype-system=\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\" />\n\n  <xsl:template match=\"/\">\n\n    <xsl:for-each select=\"planAndSuites\" >\n      <div id=\"exported-data\">\n        <style type=\"text/css\">\n          .Passed{color:darkgreen;}\n          .Failed{color:darkred;}\n          .Blocked{color:orange;}\n          .Paused{color:blue;}\n          .table{ display:table;}\n          .table-row{ display:table-row;}\n          .table-cell{ display:table-cell; padding-left:9px;}\n          .verticalheader{\n          transform: rotate(270deg);\n          transform-orgin: top right;\n          white-space: nowrap;\n          width: 25px;\n          padding: 4px;\n          padding-bottom: 3px;\n          overflow: visible;\n          }\n          .header\n          {\n          height:100px;\n          vertical-align:bottom;\n          background-color: #f5f5f5;\n          padding: 1px;\n          border-right:1px solid white;\n          }\n\n          .heading {\n          font-size: 24px;\n          font-family: 'Arial;\n          font-weight: normal;\n          margin-top: 15px;\n          margin-bottom: 15px;\n          background-color: #f5f5f5;\n          padding: 1px;\n          }\n\n          .test-case-heading.heading {\n          font-size: 20px;\n          }\n\n          .colored-table th{\n          background-color: #f5f5f5;\n          }\n\n          .table-row-even {\n          background-color: #f5f5f5;\n          }\n\n          .configuration-variable-style{\n          padding-right: 2px;\n          }\n\n          a{\n          color: #007acc;\n          cursor: pointer;\n          text-decoration: underline;\n          }\n\n          table{\n          word-break: break-all;\n          line-height:1;\n          }\n          .tab{\n          font-size: 16px;\n          font-family:'Segoe UI';\n          margin-top: 10px;\n          margin-bottom: 5px;\n          }\n\n          hr{\n          margin-top: 0px;\n          }\n\n          .sub-tab{\n          margin-top: 10px;\n          font-size: 11px;\n          font-family: 'Segoe UI';\n          font-weight: bold;\n          }\n\n          body, .body-text {\n          font-size: 13px;\n          font-family: 'Segoe UI';\n          font-weight: normal;\n          }\n\n          .table-style{\n          width: 100%;\n          }\n\n          .params-table td, .params-table th{\n          padding-right: 20px;\n          }\n\n          .shared-param-mapping th{\n          font-weight: bold;\n          background-color: white;\n          }\n\n          .property-name, th{\n          color: grey;\n          font-weight: normal;\n          }\n\n          .property-name{\n          color: grey;\n          font-weight: normal;\n          min-width: 150px;\n          }\n\n          th{\n          text-align: left;\n          }\n\n          tr{\n          vertical-align: top;\n          font-size: 13px;\n          font-family: 'Segoe UI';\n          font-weight: normal;\n          }\n\n          span.property-name{\n          padding: 3px;\n          display: inline-block;\n          }\n\n          table td,\n          td div{\n          border-spacing: 0px;\n          display: table-cell;\n          vertical-align:top;\n          }\n\n          td div p{\n          vertical-align:top;\n          margin:0px;\n          }\n\n          .test-step-attachment{\n          display:block;\n          }\n\n          .avoid-page-break{\n          page-break-inside: avoid;\n          }\n\n        </style>\n\n        <xsl:for-each select=\"testPlan\">\n          <div class=\"heading\" _locID=\"TestPlan\">\n            Test plan <xsl:call-template name=\"url-generator\"/>: <xsl:value-of select=\"@title\"/>\n          </div>\n          <xsl:for-each select=\"properties\">\n            <xsl:if test=\"*\">\n            \n              <xsl:apply-templates select=\".\"/>\n            </xsl:if>\n          </xsl:for-each>\n          <xsl:for-each select=\"description\">\n            <div class=\"tab\" _locID=\"Description\">\n              Description\n              <hr/>\n            </div>\n            <xsl:call-template name=\"childElementCopy\" />\n          </xsl:for-each>\n          <xsl:for-each select=\"suiteHierarchy\">\n            <div class=\"tab\" _locID=\"SuiteHierarchy\">\n              Test plan hierarchy\n              <hr/>\n            </div>\n            <div class=\"body-text\">\n              <div class=\"table\">\n                <div class=\"table-row header\">\n                  <div class=\"table-cell header\">Suit</div>\n                  <div class=\"table-cell header\"><div class=\"verticalheader\">Active</div></div>\n                  <div class=\"table-cell header\"><div class=\"verticalheader\">Not applicable</div></div>\n                  <div class=\"table-cell header\"><div class=\"verticalheader\">Passed</div></div>\n                  <div class=\"table-cell header\"><div class=\"verticalheader\">Failed</div>\n                  </div>\n                  <div class=\"table-cell header\"><div class=\"verticalheader\">Blocked</div></div>\n                  <div class=\"table-cell header\"><div class=\"verticalheader\">Paused</div>\n                  </div>\n                </div>\n                <xsl:call-template name=\"suiteHierarchy\">\n                  <xsl:with-param name=\"count\">\n                    <xsl:value-of select=\"0\"/>\n                  </xsl:with-param>\n                </xsl:call-template>\n              </div>\n            </div>\n          </xsl:for-each>\n\n       \n\n\n              <xsl:for-each select=\"//testCase\">\n                <div class =\"test-case-heading heading\" _locID=\"TestCase\">\n                  Test case <xsl:call-template name=\"url-generator\"/>: <xsl:value-of select=\"@title\"/>\n                </div>\n\n                <xsl:for-each select=\"properties\">\n                  <xsl:if test=\"*\">\n                    <div class=\"sub-tab\" _locID=\"Properties\">\n                      PROPERTIES\n                      <br/>\n                    </div>\n                    <xsl:apply-templates select = \".\"/>\n                  </xsl:if>\n                </xsl:for-each>\n                <xsl:comment>Summary</xsl:comment>\n\n                <xsl:for-each select=\"summary\">\n                  <div class=\"sub-tab\" _locID=\"Summary\">\n                    SUMMARY\n                    <br/>\n                  </div>\n                  <div>\n                    <xsl:copy-of select=\".\"/>\n                  </div>\n                  <br/>\n                </xsl:for-each>\n\n                <xsl:comment>TestSteps</xsl:comment>\n\n                <xsl:for-each select=\"testSteps\">\n                  <div class=\"avoid-page-break\">\n                    <div class=\"sub-tab\" _locID=\"Steps\">\n                      STEPS<br/>\n                    </div>\n                    <table class=\"table-style colored-table\">\n                      <tr>\n                        <th width=\"5%\" _locID=\"Number\">\n                          #\n                        </th>\n                        <th width =\"45%\" _locID=\"Action\">\n                          Action\n                        </th>\n                        <th width =\"25%\" _locID=\"ExpectedValue\">\n                          Expected value\n                        </th>\n                        <th width =\"25%\" _locID=\"Attachments\">\n                          Attachments\n                        </th>\n                      </tr>\n                      <xsl:for-each select=\"testStep\">\n                        <xsl:variable name=\"css-class\">\n                          <xsl:choose>\n                            <xsl:when test=\"position() mod 2 = 0\">table-row-even</xsl:when>\n                            <xsl:otherwise>table-row-odd</xsl:otherwise>\n                          </xsl:choose>\n                        </xsl:variable>\n                        <tr class=\"{$css-class}\">\n                          <td>\n                            <span>\n                              <xsl:value-of select=\"@index\"/>\n                            </span>\n                          </td>\n                          <td>\n                            <xsl:for-each select=\"testStepAction\">\n                              <xsl:call-template name=\"childElementCopy\" />\n                            </xsl:for-each>\n                          </td>\n                          <td>\n                            <xsl:for-each select=\"testStepExpected\">\n                              <xsl:call-template name=\"childElementCopy\" />\n                            </xsl:for-each>\n                          </td>\n                          <td>\n                            <xsl:for-each select=\"stepAttachments\">\n                              <div class=\"step-attachments\">\n                                <xsl:call-template name=\"childElementCopy\"/>\n                              </div>\n                            </xsl:for-each>\n                          </td>\n                        </tr>\n                      </xsl:for-each>\n                    </table>\n                  </div>\n                </xsl:for-each>\n\n                <xsl:comment>Parameters</xsl:comment>\n\n                <xsl:for-each select=\"parameters\">\n                  <div class=\"sub-tab\" _locID=\"Parameters\">\n                    PARAMETERS\n                  </div>\n                  <xsl:for-each select=\"sharedParameterDataSet\">\n                    <div class =\"sub-tab\" _locID=\"SharedParameter\">\n                      Shared parameter <xsl:call-template name=\"url-generator\"/>: <xsl:value-of select=\"@title\"/><br></br>\n                    </div>\n                  </xsl:for-each>\n                  <table class=\"params-table colored-table\">\n                    <tr class=\"shared-param-mapping\">\n                      <xsl:for-each select=\"sharedParameterMapping\">\n                        <th>\n                          <xsl:value-of select=\"@name\"/>\n                        </th>\n                      </xsl:for-each>\n                    </tr>\n                    <tr>\n                      <xsl:for-each select=\"parameterFieldName\">\n                        <th>\n                          <xsl:value-of select=\"@name\"/>\n                        </th>\n                      </xsl:for-each>\n                    </tr>\n\n                    <xsl:for-each select=\"parametersData\">\n                      <xsl:variable name=\"css-class\">\n                        <xsl:choose>\n                          <xsl:when test=\"position() mod 2 = 0\">table-row-even</xsl:when>\n                          <xsl:otherwise>table-row-odd</xsl:otherwise>\n                        </xsl:choose>\n                      </xsl:variable>\n                      <tr class=\"{$css-class}\">\n                        <xsl:for-each select=\"parameterFieldData\">\n                          <td>\n                            <xsl:value-of select=\"@name\"/>\n                          </td>\n                        </xsl:for-each>\n                      </tr>\n                    </xsl:for-each>\n                  </table>\n\n                </xsl:for-each>\n\n                <xsl:comment>LinksAndAttachements</xsl:comment>\n                <xsl:for-each select=\"linksAndAttachments\">\n                  <xsl:for-each select=\"links\">\n                    <div class=\"sub-tab\" _locID=\"Links\">\n                      LINKS\n                    </div>\n                    <table class=\"table-style\">\n                      <tr>\n                        <th width=\"5%\" _locID=\"Id\">\n                          ID\n                        </th>\n                        <th width=\"22.5%\" _locID=\"WorkItemType\">\n                          WorkItemType\n                        </th>\n                        <th width=\"22.5%\" _locID=\"LinkType\">\n                          Link type\n                        </th>\n                        <th width=\"50%\" _locID=\"Title\">\n                          Title\n                        </th>\n                      </tr>\n                      <xsl:for-each select=\"link\">\n                        <tr>\n                          <td>\n                            <xsl:call-template name=\"url-generator\"/>\n                          </td>\n                          <td>\n                            <span>\n                              <xsl:value-of select=\"@workItemType\"/>\n                            </span>\n                          </td>\n                          <td>\n                            <span>\n                              <xsl:value-of select=\"@type\"/>\n                            </span>\n                          </td>\n                          <td>\n                            <span>\n                              <xsl:value-of select=\"@title\"/>\n                            </span>\n                          </td>\n                        </tr>\n                      </xsl:for-each>\n                    </table>\n\n                  </xsl:for-each>\n\n                  <xsl:for-each select=\"attachments\">\n                    <div class=\"sub-tab\" _locID=\"Attachments\">\n                      ATTACHMENTS\n                    </div>\n                    <table class=\"table-style\">\n                      <tr>\n                        <th width=\"28%\" _locID=\"Name\">\n                          Name\n                        </th>\n                        <th width=\"22%\" _locID=\"Size\">\n                          Size\n                        </th>\n                        <th width=\"20%\" _locID=\"DateWhenAttachmentAdded\">\n                          Date Attached\n                        </th>\n                        <th width=\"30%\" _locID=\"Comments\">\n                          Comments\n                        </th>\n                      </tr>\n                      <xsl:for-each select=\"attachment\">\n                        <tr>\n                          <td>\n                            <span>\n                              <a target=\"_blank\">\n                                <xsl:attribute name=\"href\">\n                                  <xsl:value-of select=\"@url\"/>\n                                </xsl:attribute>\n                                <xsl:value-of select=\"@name\"/>\n                              </a>\n                            </span>\n                          </td>\n                          <td>\n                            <span>\n                              <xsl:value-of select=\"@size\"/>\n                            </span>\n                          </td>\n                          <td>\n                            <span>\n                              <xsl:value-of select=\"@date\"/>\n                            </span>\n                          </td>\n                          <td>\n                            <span>\n                              <xsl:value-of select=\"@comments\"/>\n                            </span>\n                          </td>\n                        </tr>\n                      </xsl:for-each>\n                    </table>\n                  </xsl:for-each>\n\n                </xsl:for-each>\n\n                <xsl:comment>Automation</xsl:comment>\n\n                <xsl:for-each select=\"automation\">\n                  <xsl:if test=\"*\">\n                    <div class=\"sub-tab\" _locID=\"AssociatedAutomation\">\n                      ASSOCIATED AUTOMATION\n                    </div>\n                    <xsl:apply-templates select=\"properties\"/>\n                  </xsl:if>\n                </xsl:for-each>\n                <br></br>\n                <hr></hr>\n              </xsl:for-each>\n            </xsl:for-each>\n      </div>\n    </xsl:for-each>\n  </xsl:template>\n\n  <xsl:template name=\"suiteHierarchy\">\n    <xsl:param name=\"count\" select=\"0\"/>\n   \n      <xsl:for-each select=\"suite\">\n        <div class=\"table-row\">\n          <div class=\"table-cell\">\n            <xsl:call-template name=\"loop\">\n              <xsl:with-param name=\"totalCount\">\n                <xsl:value-of select=\"$count\"/>\n              </xsl:with-param>\n            </xsl:call-template>\n            <xsl:value-of select=\"type\"/>\n            <xsl:choose>\n              <xsl:when test=\"@type = 'StaticTestSuite'\">\n                <span class=\"icon tree-node-img icon-tfs-tcm-static-suite\"></span>\n              </xsl:when>\n              <xsl:when test=\"@type = 'RequirementTestSuite'\">\n                <span class=\"icon tree-node-img icon-tfs-tcm-requirement-based-suite\"></span>\n              </xsl:when>\n              <xsl:when test=\"@type = 'DynamicTestSuite'\">\n                <span class=\"icon tree-node-img icon-tfs-tcm-query-based-suite\"></span>\n              </xsl:when>\n            </xsl:choose>\n\n            <xsl:value-of select=\"@title\"/>:&#160;<span>\n              <xsl:call-template name=\"url-generator\"/>\n            </span>\n          </div>\n          <div class=\"table-cell Active\">\n            <xsl:value-of select =\"@totalActive\" />\n          </div>\n          <div class=\"table-cell NotApplicable\">\n            <xsl:value-of select =\"@totalNotApplicable\" />\n          </div>\n          <div class=\"table-cell Passed\">\n            <xsl:value-of select =\"@totalPassed\" />\n          </div>\n          <div class=\"table-cell Failed\">\n            <xsl:value-of select =\"@totalFailed\" />\n          </div>\n          <div class=\"table-cell Blocked\">\n            <xsl:value-of select =\"@totalBlocked\" />\n          </div>\n          <div class=\"table-cell Paused\">\n            <xsl:value-of select =\"@totalPaused\" />\n          </div>\n        </div>\n       \n        <xsl:for-each select=\"//testSuite[@id=current()/@id]/testCases/testCase\">\n          <div class=\"table-row\">\n            <div class=\"table-cell\">\n              <xsl:call-template name=\"loop\">\n                <xsl:with-param name=\"totalCount\">\n                  <xsl:value-of select=\"$count+2\"/>\n                </xsl:with-param>\n              </xsl:call-template>\n              <span class=\"icon tree-node-img icon icon-tfs-tcm-bug-white\"></span>\n              <xsl:value-of select=\"@title\" />\n              <xsl:call-template name=\"url-generator\"/>\n            </div>\n            <div class=\"table-cell Active\">\n              <xsl:value-of select =\"@active\" />\n            </div>\n            <div class=\"table-cell NotApplicable\">\n              <xsl:value-of select =\"@notApplicable\" />\n            </div>\n            <div class=\"table-cell Passed\">\n              <xsl:value-of select =\"@passed\" />\n            </div>\n            <div class=\"table-cell Failed\">\n              <xsl:value-of select =\"@failed\" />\n            </div>\n            <div class=\"table-cell Blocked\">\n              <xsl:value-of select =\"@blocked\" />\n            </div>\n            <div class=\"table-cell Paused\">\n              <xsl:value-of select =\"@paused\" />\n            </div>\n            <div class=\"table\"></div>\n            <xsl:for-each select =\"latestTestOutcomes/testResult\" >\n              <xsl:variable name =\"outcome\" select=\"properties/property[@name='Outcome']/@value\" />\n              <div class=\"table-cell\">\n                <xsl:value-of select =\"properties/property[@name='Configuration']/@value\" />\n              </div>\n                <div class=\"table-cell {$outcome}\">\n                  <xsl:value-of select =\"$outcome\" />\n                </div>\n                </xsl:for-each >\n          \n          </div>\n        </xsl:for-each >\n\n        <xsl:call-template name=\"suiteHierarchy\">\n          <xsl:with-param name=\"count\">\n            <xsl:value-of select=\"$count+4\"/>\n          </xsl:with-param>\n        </xsl:call-template>\n\n      </xsl:for-each>\n    \n  </xsl:template>\n\n  <xsl:template name=\"loop\">\n    <xsl:param name=\"count\" select=\"0\"/>\n    <xsl:param name=\"totalCount\"></xsl:param>\n    <xsl:if test=\"($count &lt; $totalCount)\">\n      &#160;\n      <xsl:call-template name=\"loop\">\n        <xsl:with-param name=\"count\">\n          <xsl:value-of select=\"$count + 1\"/>\n        </xsl:with-param>\n        <xsl:with-param name=\"totalCount\">\n          <xsl:value-of select=\"$totalCount\"/>\n        </xsl:with-param>\n      </xsl:call-template>\n    </xsl:if>\n  </xsl:template>\n\n\n  <xsl:template match=\"configuration\">\n    <tr>\n      <td>\n        <xsl:value-of select=\"@id\"/>\n      </td>\n      <td>\n        <xsl:value-of select=\"@value\"/>\n      </td>\n      <td>\n        <xsl:for-each select=\"variables\">\n          <span class=\"configuration-variable-style\">\n            <xsl:value-of select=\"@name\"/>:\n            <xsl:value-of select=\"@value\"/>\n            <xsl:if test=\"position()!=last()\">\n              ;\n            </xsl:if>\n          </span>\n        </xsl:for-each>\n      </td>\n    </tr>\n  </xsl:template>\n\n  <xsl:template match=\"properties\">\n    <table class=\"body-text\">\n      <xsl:for-each select=\"property\">\n        <tr>\n          <td class=\"property-name\">\n            <xsl:value-of select=\"@name\"/>:\n          </td>\n          <td>\n            <xsl:value-of select=\"@value\"/>\n          </td>\n        </tr>\n      </xsl:for-each>\n    </table>\n  </xsl:template>\n\n  <xsl:template name=\"url-generator\" >\n    <a target=\"_blank\">\n      <xsl:attribute name=\"href\">\n        <xsl:value-of select=\"@url\"/>\n      </xsl:attribute>\n      <xsl:value-of select=\"@id\"/>\n    </a>\n  </xsl:template>\n\n  <xsl:template name=\"childElementCopy\">\n    <xsl:copy-of select=\"node()\"/>\n  </xsl:template>\n\n</xsl:stylesheet>", "serviceName": "TestPlan", "unSaved": "", "__etag": -1 },
                        { "id": "mskold-MSFTTestPlan", "name": "MSFT Test Plan", "serviceName": "TestPlan", "description": "", "docType": "doc", "template": "<?xml version=\"1.0\" encoding=\"utf-8\" ?> <xsl:stylesheet version=\"1.0\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:fo=\"http://www.w3.org/1999/XSL/Format\" >\n     <xsl:output method=\"html\" indent=\"yes\" encoding=\"utf-8\" doctype-public=\"-//W3C//DTD XHTML 1.0 Transitional//EN\" doctype-system=\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\" />    <xsl:template match=\"/\">\n          <xsl:for-each select=\"planAndSuites\" >\n             <div id=\"exported-data\">\n                 <style type=\"text/css\">           .heading {           font-size: 24px;           font-family: 'Segoe UI Light';           font-weight: normal;           margin-top: 15px;           margin-bottom: 15px;           background-color: #f5f5f5;           padding: 1px;           }                      .test-case-heading.heading {           font-size: 20px;           }            .colored-table th{           background-color: #f5f5f5;           }            .table-row-even {           background-color: #f5f5f5;           }            .configuration-variable-style{           padding-right: 2px;           }            a{           color: #007acc;           cursor: pointer;           text-decoration: underline;           }            table{           word-break: break-all; \\t        line-height:1;           }           .tab{           font-size: 16px;           font-family:'Segoe UI';           margin-top: 10px;           margin-bottom: 5px;           }            hr{           margin-top: 0px;           }            .sub-tab{           margin-top: 10px;           font-size: 11px;           font-family: 'Segoe UI';           font-weight: bold;           }            body, .body-text {           font-size: 13px;           font-family: 'Segoe UI';           font-weight: normal;           }            .table-style{           width: 100%;           }            .params-table td, .params-table th{           padding-right: 20px;           }                      .shared-param-mapping th{           font-weight: bold;           background-color: white;           }            .property-name, th{           color: grey;           font-weight: normal;           }            .property-name{           color: grey;           font-weight: normal;           min-width: 150px;           }            th{           text-align: left;           }            tr{           vertical-align: top;           font-size: 13px;           font-family: 'Segoe UI';           font-weight: normal;           }            span.property-name{           padding: 3px;           display: inline-block;           }            table td,           td div{           border-spacing: 0px;           display: table-cell;           vertical-align:top;           }            td div p{           vertical-align:top;           margin:0px;           }                      .test-step-attachment{           display:block;           }                      .avoid-page-break{           page-break-inside: avoid;           }          </style>          <xsl:for-each select=\"testPlan\">\n                     <div class=\"heading\" _locID=\"TestPlan\">\n                         Test plan <xsl:call-template name=\"url-generator\"/>: <xsl:value-of select=\"@title\"/> \n          </div>           <xsl:for-each select=\"properties\">\n                         <xsl:if test=\"*\">\n                             <div class=\"tab\" _locID=\"Properties\">\n                                 Properties                 <hr/> \n              </div>               <xsl:apply-templates select=\".\"/> \n            </xsl:if> \n          </xsl:for-each>           <xsl:for-each select=\"description\">\n                         <div class=\"tab\" _locID=\"Description\">\n                             Description               <hr/> \n            </div>             <xsl:call-template name=\"childElementCopy\" /> \n          </xsl:for-each>           <xsl:for-each select=\"suiteHierarchy\">\n                         <div class=\"tab\" _locID=\"SuiteHierarchy\">\n                             Suite hierarchy               <hr/> \n            </div>             <div class=\"body-text\">\n                             <xsl:call-template name=\"suiteHierarchy\">\n                                 <xsl:with-param name=\"count\">\n                                     <xsl:value-of select=\"0\"/> \n                </xsl:with-param> \n              </xsl:call-template> \n            </div> \n          </xsl:for-each>            <xsl:for-each select=\"configurations\">\n                         <div class=\"tab\" _locID=\"Configurations\">\n                             Configurations               <hr/> \n            </div>             <div class =\"sub-tab\" _locID=\"ConfigurationsInThisTestPlan\">               CONFIGURATIONS IN TEST PLAN             </div>             <table class=\"table-style\">\n                             <tr>\n                                 <th width=\"5%\" _locID=\"Id\">Id</th>                 <th width=\"45%\" _locID=\"Name\">Name</th>                 <th width=\"50%\" _locID=\"ConfigurationVariables\">Configuration variables</th> \n              </tr>               <xsl:for-each select=\"planConfiguration\">\n                                 <xsl:apply-templates select = \"configuration\"/> \n              </xsl:for-each> \n            </table>              <xsl:for-each select=\"additionalConfiguration\">\n                             <div class =\"sub-tab\" _locID=\"AdditionalConfigurations\">                 ADDITIONAL CONFIGURATIONS REFERENCED BY CHILD SUITES               </div>               <table class=\"table-style\">\n                                 <tr>\n                                     <th width=\"5%\" _locID=\"Id\">Id</th>                   <th width=\"45%\" _locID=\"Name\">Name</th>                   <th width=\"50%\" _locID=\"ConfigurationVariables\">Configuration variables</th> \n                </tr>                 <xsl:apply-templates select = \"configuration\"/> \n              </table> \n            </xsl:for-each> \n          </xsl:for-each>             <xsl:for-each select=\"testPlanSettings\">\n                         <div class=\"tab\" _locID=\"RunSettings\">\n                             Run settings               <hr/> \n            </div>             <table class=\"table-style\">\n                          <tr>\n                                 <th></th> \\t\\t            <th></th> \\t\n              </tr>               <tr>\n                                 <td>\n                                     <xsl:for-each select=\"manualRuns\">\n                                         <div class =\"sub-tab\" _locID=\"ManualRuns\">                       MANUAL RUNS                     </div>                     <xsl:apply-templates select = \"properties\"/> \n                  </xsl:for-each>                   <br /> \n                </td>                 <td>\n                                     <xsl:for-each select=\"automatedRuns\">\n                                         <div class =\"sub-tab\" _locID=\"AutomatedRuns\">                       AUTOMATED RUNS                     </div>                    <xsl:apply-templates select = \"properties\"/> \n                  </xsl:for-each> \n                </td> \n              </tr>               <tr>\n                                 <td>\n                                     <xsl:for-each select=\"builds\">\n                                         <div class=\"sub-tab\" _locID=\"Build\">                       BUILD                     </div>                     <xsl:apply-templates select = \"properties\"/> \n                  </xsl:for-each> \n                </td> \n              </tr> \n            </table> \n          </xsl:for-each> \n        </xsl:for-each>           <xsl:for-each select=\"testSuites\">\n                     <xsl:for-each select=\"testSuite\">\n                          <div class=\"heading\" _locID=\"TestSuite\">\n                             Test suite <xsl:call-template name=\"url-generator\"/>: <xsl:value-of select=\"@title\"/> \n            </div>              <xsl:for-each select=\"suiteProperties\">\n                             <div class=\"tab\" _locID=\"Properties\">\n                                 Properties                 <hr/> \n              </div>                 <div>\n                                 <xsl:apply-templates select = \"properties\"/>                 <table class=\"body-text\">\n                                     <xsl:for-each select=\"requirement\">\n                                         <tr>\n                                             <td class=\"property-name\" _locID=\"Requirement\">                         Requirement:                       </td>                       <td>\n                                                 <xsl:call-template name=\"url-generator\"/>: <xsl:value-of select=\"@title\"/> \n                      </td> \n                    </tr> \n                  </xsl:for-each>                   <xsl:for-each select=\"configurations\">\n                                         <tr>\n                                             <td class=\"property-name\" _locID=\"Configurations\">                         Configurations:                       </td>                       <td>\n                                                 <xsl:for-each select=\"configuration\">\n                                                     <xsl:value-of select=\"@value\"/>                           <xsl:if test=\"position()!=last()\">                             ;                           </xsl:if> \n                        </xsl:for-each> \n                      </td> \n                    </tr> \n                  </xsl:for-each> \n                </table> \n              </div> \n            </xsl:for-each>              <xsl:for-each select=\"testCases\">\n                              <div class=\"tab\" _locID=\"TestCases\">\n                                 Test cases&#160;(<xsl:value-of select=\"@count\"/>)                 <hr/> \n              </div>                <xsl:for-each select=\"testCase\">\n                                 <div class =\"test-case-heading heading\" _locID=\"TestCase\">\n                                     Test case <xsl:call-template name=\"url-generator\"/>: <xsl:value-of select=\"@title\"/> \n                </div>                  <xsl:for-each select=\"properties\">\n                                     <xsl:if test=\"*\">\n                                         <div class=\"sub-tab\" _locID=\"Properties\">\n                                             PROPERTIES                       <br/> \n                    </div>                     <xsl:apply-templates select = \".\"/> \n                  </xsl:if> \n                </xsl:for-each>                 <xsl:comment>Summary</xsl:comment>                  <xsl:for-each select=\"summary\">\n                                     <div class=\"sub-tab\" _locID=\"Summary\">\n                                         SUMMARY                     <br/> \n                  </div>                   <div>\n                                         <xsl:copy-of select=\".\"/> \n                  </div>                   <br/> \n                </xsl:for-each>                  <xsl:comment>TestSteps</xsl:comment>                  <xsl:for-each select=\"testSteps\">\n                                     <div class=\"avoid-page-break\">\n                                       <div class=\"sub-tab\" _locID=\"Steps\">\n                                           STEPS<br/> \n                    </div>                   <table class=\"table-style colored-table\">\n                                           <tr>\n                                               <th width=\"5%\" _locID=\"Number\">                         #                       </th>                       <th width =\"45%\" _locID=\"Action\">                         Action                       </th>                       <th width =\"25%\" _locID=\"ExpectedValue\">                         Expected value                       </th>                       <th width =\"25%\" _locID=\"Attachments\">                         Attachments                       </th> \n                      </tr>                     <xsl:for-each select=\"testStep\">\n                                               <xsl:variable name=\"css-class\">\n                                                   <xsl:choose>\n                                                       <xsl:when test=\"position() mod 2 = 0\">table-row-even</xsl:when>                           <xsl:otherwise>table-row-odd</xsl:otherwise> \n                          </xsl:choose> \n                        </xsl:variable>                       <tr class=\"{$css-class}\">\n                                                   <td>\n                                                       <span>\n                                                           <xsl:value-of select=\"@index\"/> \n                            </span> \n                          </td>                         <td>\n                                                       <xsl:for-each select=\"testStepAction\">\n                                                           <xsl:call-template name=\"childElementCopy\" /> \n                            </xsl:for-each> \n                          </td>                         <td>\n                                                       <xsl:for-each select=\"testStepExpected\">\n                                                           <xsl:call-template name=\"childElementCopy\" /> \n                            </xsl:for-each> \n                          </td>                         <td>\n                                                       <xsl:for-each select=\"stepAttachments\">\n                                                           <div class=\"step-attachments\">\n                                                               <xsl:call-template name=\"childElementCopy\"/> \n                              </div> \n                            </xsl:for-each> \n                          </td> \n                        </tr> \n                      </xsl:for-each> \n                    </table> \n                  </div> \n                </xsl:for-each>                  <xsl:comment>Parameters</xsl:comment>                  <xsl:for-each select=\"parameters\">\n                                     <div class=\"sub-tab\" _locID=\"Parameters\">                     PARAMETERS                   </div>                   <xsl:for-each select=\"sharedParameterDataSet\">\n                                         <div class =\"sub-tab\" _locID=\"SharedParameter\">\n                                             Shared parameter <xsl:call-template name=\"url-generator\"/>: <xsl:value-of select=\"@title\"/><br></br> \n                    </div> \n                  </xsl:for-each>                   <table class=\"params-table colored-table\">\n                                         <tr class=\"shared-param-mapping\">\n                                             <xsl:for-each select=\"sharedParameterMapping\">\n                                                 <th>\n                                                     <xsl:value-of select=\"@name\"/> \n                        </th> \n                      </xsl:for-each> \n                    </tr>                     <tr>\n                                             <xsl:for-each select=\"parameterFieldName\">\n                                                 <th>\n                                                     <xsl:value-of select=\"@name\"/> \n                        </th> \n                      </xsl:for-each> \n                    </tr>                      <xsl:for-each select=\"parametersData\">\n                                             <xsl:variable name=\"css-class\">\n                                                 <xsl:choose>\n                                                     <xsl:when test=\"position() mod 2 = 0\">table-row-even</xsl:when>                           <xsl:otherwise>table-row-odd</xsl:otherwise> \n                        </xsl:choose> \n                      </xsl:variable>                       <tr class=\"{$css-class}\">\n                                                 <xsl:for-each select=\"parameterFieldData\">\n                                                     <td>\n                                                         <xsl:value-of select=\"@name\"/> \n                          </td> \n                        </xsl:for-each> \n                      </tr> \n                    </xsl:for-each> \n                  </table>  \n                </xsl:for-each>                  <xsl:comment>LinksAndAttachements</xsl:comment>                 <xsl:for-each select=\"linksAndAttachments\">\n                                     <xsl:for-each select=\"links\">\n                                         <div class=\"sub-tab\" _locID=\"Links\">                       LINKS                     </div>                     <table class=\"table-style\">\n                                             <tr>\n                                                 <th width=\"5%\" _locID=\"Id\">                           ID                         </th>                         <th width=\"22.5%\" _locID=\"WorkItemType\">                           WorkItemType                         </th>                         <th width=\"22.5%\" _locID=\"LinkType\">                           Link type                         </th>                         <th width=\"50%\" _locID=\"Title\">                           Title                         </th> \n                      </tr>                       <xsl:for-each select=\"link\">\n                                                 <tr>\n                                                     <td>\n                                                         <xsl:call-template name=\"url-generator\"/> \n                          </td>                           <td>\n                                                         <span>\n                                                             <xsl:value-of select=\"@workItemType\"/> \n                            </span> \n                          </td>                           <td>\n                                                         <span>\n                                                             <xsl:value-of select=\"@type\"/> \n                            </span> \n                          </td>                           <td>\n                                                         <span>\n                                                             <xsl:value-of select=\"@title\"/> \n                            </span> \n                          </td> \n                        </tr> \n                      </xsl:for-each> \n                    </table>  \n                  </xsl:for-each>                    <xsl:for-each select=\"attachments\">\n                                         <div class=\"sub-tab\" _locID=\"Attachments\">                       ATTACHMENTS                     </div>                     <table class=\"table-style\">\n                                             <tr>\n                                                 <th width=\"28%\" _locID=\"Name\">                           Name                         </th>                         <th width=\"22%\" _locID=\"Size\">                           Size                         </th>                         <th width=\"20%\" _locID=\"DateWhenAttachmentAdded\">                           Date Attached                         </th>                         <th width=\"30%\" _locID=\"Comments\">                           Comments                         </th> \n                      </tr>                       <xsl:for-each select=\"attachment\">\n                                                 <tr>\n                                                     <td>\n                                                         <span>\n                                                             <a target=\"_blank\">\n                                                                 <xsl:attribute name=\"href\">\n                                                                     <xsl:value-of select=\"@url\"/> \n                                </xsl:attribute>                                 <xsl:value-of select=\"@name\"/> \n                              </a> \n                            </span> \n                          </td>                           <td>\n                                                         <span>\n                                                             <xsl:value-of select=\"@size\"/> \n                            </span> \n                          </td>                           <td>\n                                                         <span>\n                                                             <xsl:value-of select=\"@date\"/> \n                            </span> \n                          </td>                           <td>\n                                                         <span>\n                                                             <xsl:value-of select=\"@comments\"/> \n                            </span> \n                          </td> \n                        </tr> \n                      </xsl:for-each> \n                    </table> \n                  </xsl:for-each>  \n                </xsl:for-each>                  <xsl:comment>Automation</xsl:comment>                  <xsl:for-each select=\"automation\">\n                                     <xsl:if test=\"*\">\n                                         <div class=\"sub-tab\" _locID=\"AssociatedAutomation\">                       ASSOCIATED AUTOMATION                     </div>                     <xsl:apply-templates select=\"properties\"/> \n                  </xsl:if> \n                </xsl:for-each>                 <xsl:comment>Latest Test Outcome</xsl:comment>                 <xsl:for-each select=\"latestTestOutcomes\">\n                                     <div class=\"avoid-page-break\">\n                                         <div class=\"sub-tab\" _locID=\"LatestTestOutcome\">\n                                             LATEST TEST OUTCOME<br/> \n                    </div> \n                  </div>                    <table class=\"table-style colored-table\">\n                                         <xsl:for-each select=\"testResult\">\n                                             <xsl:if test=\"position() = 1\">\n                                                 <xsl:for-each select=\"properties\">\n                                                     <tr>\n                                                         <xsl:for-each select=\"property\">\n                                                             <th>\n                                                                 <xsl:value-of select=\"@name\"/> \n                              </th> \n                            </xsl:for-each> \n                          </tr> \n                        </xsl:for-each> \n                      </xsl:if>                       <xsl:variable name=\"css-class\">\n                                                 <xsl:choose>\n                                                     <xsl:when test=\"position() mod 2 = 0\">table-row-even</xsl:when>                           <xsl:otherwise>table-row-odd</xsl:otherwise> \n                        </xsl:choose> \n                      </xsl:variable>                       <xsl:for-each select=\"properties\">\n                                                 <tr class=\"{$css-class}\">\n                                                     <xsl:for-each select=\"property\">\n                                                         <td>\n                                                             <xsl:choose>\n                                                                   <xsl:when test=\"@url != ''\">\n                                                                         <span>\n                                                                            <a target=\"_blank\">\n                                                                                 <xsl:attribute name=\"href\">\n                                                                                     <xsl:value-of select=\"@url\"/> \n                                      </xsl:attribute>                                           <xsl:value-of select=\"@value\"/> \n                                    </a> \n                                  </span> \n                                </xsl:when>                                   <xsl:otherwise>\n                                                                         <xsl:value-of select=\"@value\" /> \n                                </xsl:otherwise> \n                              </xsl:choose> \n                            </td> \n                          </xsl:for-each> \n                        </tr> \n                      </xsl:for-each> \n                    </xsl:for-each> \n                  </table>  \n                </xsl:for-each> \n              </xsl:for-each>               <br></br>               <hr></hr> \n            </xsl:for-each> \n          </xsl:for-each> \n        </xsl:for-each> \n      </div> \n    </xsl:for-each> \n  </xsl:template>    <xsl:template name=\"suiteHierarchy\">\n         <xsl:param name=\"count\" select=\"0\"/>     <xsl:for-each select=\"suite\">\n             <xsl:call-template name=\"loop\">\n                 <xsl:with-param name=\"totalCount\">\n                     <xsl:value-of select=\"$count\"/> \n        </xsl:with-param> \n      </xsl:call-template>       <xsl:value-of select=\"@type\"/>:&#160;<span>\n                 <xsl:value-of select=\"@title\"/> (ID: <xsl:call-template name=\"url-generator\"/>) \n      </span>       <br/>       <xsl:call-template name=\"suiteHierarchy\">\n                 <xsl:with-param name=\"count\">\n                     <xsl:value-of select=\"$count+4\"/> \n        </xsl:with-param> \n      </xsl:call-template>  \n    </xsl:for-each>  \n  </xsl:template>    <xsl:template name=\"loop\">\n         <xsl:param name=\"count\" select=\"0\"/>     <xsl:param name=\"totalCount\"></xsl:param>     <xsl:if test=\"($count &lt; $totalCount)\">\n             &#160;       <xsl:call-template name=\"loop\">\n                 <xsl:with-param name=\"count\">\n                     <xsl:value-of select=\"$count + 1\"/> \n        </xsl:with-param>         <xsl:with-param name=\"totalCount\">\n                     <xsl:value-of select=\"$totalCount\"/> \n        </xsl:with-param> \n      </xsl:call-template> \n    </xsl:if> \n  </xsl:template>     <xsl:template match=\"configuration\">\n         <tr>\n             <td>\n                 <xsl:value-of select=\"@id\"/> \n      </td>       <td>\n                 <xsl:value-of select=\"@value\"/> \n      </td>       <td>\n                 <xsl:for-each select=\"variables\">\n                     <span class=\"configuration-variable-style\">\n                         <xsl:value-of select=\"@name\"/>:             <xsl:value-of select=\"@value\"/>             <xsl:if test=\"position()!=last()\">               ;             </xsl:if> \n          </span> \n        </xsl:for-each> \n      </td> \n    </tr> \n  </xsl:template>    <xsl:template match=\"properties\">\n         <table class=\"body-text\">\n             <xsl:for-each select=\"property\">\n                 <tr>\n                     <td class=\"property-name\">\n                         <xsl:value-of select=\"@name\"/>: \n          </td>           <td>\n                         <xsl:value-of select=\"@value\"/> \n          </td> \n        </tr> \n      </xsl:for-each> \n    </table> \n  </xsl:template>    <xsl:template name=\"url-generator\" >\n         <a target=\"_blank\">\n             <xsl:attribute name=\"href\">\n                 <xsl:value-of select=\"@url\"/> \n      </xsl:attribute>       <xsl:value-of select=\"@id\"/> \n    </a> \n  </xsl:template>    <xsl:template name=\"childElementCopy\">\n         <xsl:copy-of select=\"node()\"/> \n  </xsl:template>  \n</xsl:stylesheet>", "unSaved": "", "__etag": -1 },
                        { "id": "mskold-TestPointGrid", "name": "Test Point Grid", "serviceName": "TestPlan", "description": "", "docType": "xls", "template": "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<xsl:stylesheet version=\"1.0\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:fo=\"http://www.w3.org/1999/XSL/Format\">\n  <xsl:output method=\"html\" indent=\"yes\" encoding=\"utf-8\" doctype-public=\"-//W3C//DTD XHTML 1.0 Transitional//EN\" doctype-system=\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"/>\n  <xsl:template match=\"/\">\n    <xsl:for-each select=\"planAndSuites\">\n      <div id=\"exported-data\">\n        <style type=\"text/css\">\n          .heading {           font-size: 24px;           font-family: 'Segoe UI Light';           font-weight: normal;           margin-top: 15px;           margin-bottom: 15px;           background-color: #f5f5f5;           padding: 1px;           }                      .test-case-heading.heading {           font-size: 20px;           }            .colored-table th{           background-color: #f5f5f5;           }            .table-row-even {           background-color: #f5f5f5;           }            .configuration-variable-style{           padding-right: 2px;           }            a{           color: #007acc;           cursor: pointer;           text-decoration: underline;           }            table{           word-break: break-all; \\t        line-height:1;           }           .tab{           font-size: 16px;           font-family:'Segoe UI';           margin-top: 10px;           margin-bottom: 5px;           }            hr{           margin-top: 0px;           }            .sub-tab{           margin-top: 10px;           font-size: 11px;           font-family: 'Segoe UI';           font-weight: bold;           }            body, .body-text {           font-size: 13px;           font-family: 'Segoe UI';           font-weight: normal;           }            .table-style{           width: 100%;           }            .params-table td, .params-table th{           padding-right: 20px;           }                      .shared-param-mapping th{           font-weight: bold;           background-color: white;           }            .property-name, th{           color: grey;           font-weight: normal;           }            .property-name{           color: grey;           font-weight: normal;           min-width: 150px;           }            th{           text-align: left;           }            tr{           vertical-align: top;           font-size: 13px;           font-family: 'Segoe UI';           font-weight: normal;           }            span.property-name{           padding: 3px;           display: inline-block;           }            table td,           td div{           border-spacing: 0px;           display: table-cell;           vertical-align:top;           }            td div p{           vertical-align:top;           margin:0px;           }                      .test-step-attachment{           display:block;           }                      .avoid-page-break{           page-break-inside: avoid;           }\n        </style>\n\n\n        <xsl:for-each select=\"testPlan\">\n          <div class=\"heading\" _locID=\"TestPlan\">\n            Test plan\n            <xsl:call-template name=\"url-generator\"/>: <xsl:value-of select=\"@title\"/>\n          </div>\n          <xsl:for-each select=\"properties\">\n            <xsl:if test=\"*\">\n              <div class=\"tab\" _locID=\"Properties\">\n                Properties                 <hr/>\n              </div>\n              <xsl:apply-templates select=\".\"/>\n            </xsl:if>\n          </xsl:for-each>\n          <xsl:for-each select=\"description\">\n            <div class=\"tab\" _locID=\"Description\">\n              Description               <hr/>\n            </div>\n            <xsl:call-template name=\"childElementCopy\"/>\n          </xsl:for-each>\n          <div class=\"tab\">\n            Test Points<hr/>\n          </div>\n          <div class=\"body-text\">\n            <xsl:call-template name=\"testPoint\"/>\n\n          </div>\n        </xsl:for-each>\n      </div>\n    </xsl:for-each>\n  </xsl:template>\n  <xsl:template name=\"testPoint\">\n    <table class=\"table-style colored-table\">\n      <xsl:for-each select=\"//testResult\">\n\n        <xsl:if test=\"position() = 1\">\n          <tr>\n            <th>Suite</th>\n            <th>Test Case</th>\n            <xsl:for-each select=\"properties\">\n\n              <xsl:for-each select=\"property\">\n                <th>\n                  <xsl:value-of select=\"@name\"/>\n                </th>\n              </xsl:for-each>\n              <th>Attatchments</th>\n            </xsl:for-each>\n          </tr>\n        </xsl:if>\n        <xsl:variable name=\"css-class\">\n          <xsl:choose>\n            <xsl:when test=\"position() mod 2 = 0\">table-row-even</xsl:when>\n            <xsl:otherwise>table-row-odd</xsl:otherwise>\n          </xsl:choose>\n        </xsl:variable>\n         <tr class=\"{$css-class}\">\n        <xsl:for-each select=\"properties\">\n\n          <td>\n            <xsl:value-of select=\"../../../@suitePath\" />\n          </td>\n\n          <td>\n              <xsl:value-of select=\"../../../@title\" />\n            </td>\n            <xsl:for-each select=\"property\">\n\n              <td>\n                <xsl:choose>\n                  <xsl:when test=\"@url != ''\">\n                    <span>\n                      <a target=\"_blank\">\n                        <xsl:attribute name=\"href\">\n                          <xsl:value-of select=\"@url\"/>\n                        </xsl:attribute>\n                        <xsl:value-of select=\"@value\"/>\n                      </a>\n                    </span>\n                  </xsl:when>\n                  <xsl:otherwise>\n                    <xsl:value-of select=\"@value\"/>\n                  </xsl:otherwise>\n                </xsl:choose>\n              </td>\n            </xsl:for-each>\n\n            </xsl:for-each>\n        <td>\n           <xsl:for-each select=\"testResultAttatchments\">\n             \n\n               <xsl:for-each select=\"attatchment\">\n                 <span>\n                   <a target=\"_blank\">\n                     <xsl:attribute name=\"href\">\n                       <xsl:value-of select=\"@url\"/>\n                     </xsl:attribute>\n                     <xsl:value-of select=\"@fileName\"/>\n                   </a>\n                 </span>  <br />\n               </xsl:for-each>\n           </xsl:for-each>\n         </td>\n\n       </tr>\n       </xsl:for-each>\n      \n    </table>\n\n  </xsl:template>\n  <xsl:template name=\"loop\">\n    <xsl:param name=\"count\" select=\"0\"/>\n    <xsl:param name=\"totalCount\"/>\n    <xsl:if test=\"($count &lt; $totalCount)\">\n      &#160;       <xsl:call-template name=\"loop\">\n        <xsl:with-param name=\"count\">\n          <xsl:value-of select=\"$count + 1\"/>\n        </xsl:with-param>\n        <xsl:with-param name=\"totalCount\">\n          <xsl:value-of select=\"$totalCount\"/>\n        </xsl:with-param>\n      </xsl:call-template>\n    </xsl:if>\n  </xsl:template>\n  <xsl:template match=\"configuration\">\n    <tr>\n      <td>\n        <xsl:value-of select=\"@id\"/>\n      </td>\n      <td>\n        <xsl:value-of select=\"@value\"/>\n      </td>\n      <td>\n        <xsl:for-each select=\"variables\">\n          <span class=\"configuration-variable-style\">\n            <xsl:value-of select=\"@name\"/>:             <xsl:value-of select=\"@value\"/>             <xsl:if test=\"position()!=last()\">               ;             </xsl:if>\n          </span>\n        </xsl:for-each>\n      </td>\n    </tr>\n  </xsl:template>\n  <xsl:template match=\"properties\">\n    <table class=\"body-text\">\n      <xsl:for-each select=\"property\">\n        <tr>\n          <td class=\"property-name\">\n            <xsl:value-of select=\"@name\"/>:\n          </td>\n          <td>\n            <xsl:value-of select=\"@value\"/>\n          </td>\n        </tr>\n      </xsl:for-each>\n    </table>\n  </xsl:template>\n  <xsl:template name=\"url-generator\">\n    <a target=\"_blank\">\n      <xsl:attribute name=\"href\">\n        <xsl:value-of select=\"@url\"/>\n      </xsl:attribute>\n      <xsl:value-of select=\"@id\"/>\n    </a>\n  </xsl:template>\n  <xsl:template name=\"childElementCopy\">\n    <xsl:copy-of select=\"node()\"/>\n  </xsl:template>\n</xsl:stylesheet>", "unSaved": "", "__etag": -1 }
                    ]
                });
            }
            else {
                deferred.reject("No default template");
            }
            
        });

    return deferred.promise();
}